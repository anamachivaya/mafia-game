<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mafia Host Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      padding: 2rem; 
      background: #0f172a; 
      color: #e2e8f0; 
      min-height: 100vh;
      margin: 0;
    }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { 
      margin-top: 0; 
      font-size: 1.8rem; 
      color: #f1f5f9;
    }
    .sub { 
      color: #94a3b8; 
      margin-bottom: 2rem; 
    }
    .panel { 
      background: #1e293b; 
      padding: 1.5rem; 
      margin: 1rem 0; 
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
      border: 1px solid #334155;
    }
    .btn { 
      padding: 0.6rem 1rem; 
      font-size: 0.9rem; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      margin-right: 0.5rem; 
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-success { 
      background: #059669; 
      color: white; 
    }
    .btn-success:hover { 
      background: #047857; 
    }
    .btn-danger { 
      background: #dc2626; 
      color: white; 
    }
    .btn-danger:hover { 
      background: #b91c1c; 
    }
    .btn:disabled { 
      background: #475569; 
      cursor: not-allowed; 
      color: #94a3b8;
    }
    .badge { 
      background: #2563eb; 
      color: white; 
      padding: 0.25rem 0.5rem; 
      border-radius: 6px; 
      font-size: 0.8rem; 
    }
    .status { 
      padding: 1rem; 
      border-radius: 8px; 
      margin-bottom: 1rem; 
    }
    .status.waiting { 
      background: #451a03; 
      color: #fbbf24; 
      border: 1px solid #92400e; 
    }
    .status.ready { 
      background: #064e3b; 
      color: #34d399; 
      border: 1px solid #059669; 
    }
    .count { 
      background: #374151; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-weight: bold; 
      color: #f1f5f9;
    }
    .small { 
      font-size: 0.85rem; 
      color: #94a3b8; 
    }
    .time { 
      margin-top: 0.5rem; 
    }
    .total-count { 
      margin-top: 1rem; 
      font-weight: bold; 
      color: #f1f5f9;
    }
    .role-input { 
      display: flex; 
      gap: 0.5rem; 
      margin-bottom: 0.5rem; 
      align-items: center; 
    }
    .role-input input[type="text"] { 
      flex: 2; 
      padding: 0.5rem; 
      border: 1px solid #475569; 
      border-radius: 6px; 
      background: #374151;
      color: #f1f5f9;
    }
    .role-input input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .role-input input[type="number"] { 
      flex: 1; 
      padding: 0.5rem; 
      border: 1px solid #475569; 
      border-radius: 6px; 
      background: #374151;
      color: #f1f5f9;
    }
    .role-input input[type="number"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .remove-btn { 
      background: #dc2626; 
      padding: 0.25rem 0.5rem; 
      font-size: 0.8rem; 
      color: white;
    }
    .remove-btn:hover {
      background: #b91c1c;
    }
    
    /* Player roles display styles */
    .player-roles { 
      margin-top: 1rem; 
    }
    .player-role-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 0.75rem; 
      margin: 0.5rem 0; 
      background: #374151; 
      border-radius: 8px; 
      border-left: 4px solid #fbbf24;
    }
    .player-name { 
      font-weight: 600; 
      color: #f1f5f9;
    }
    .player-role { 
      background: #fbbf24; 
      color: #92400e; 
      padding: 0.25rem 0.75rem; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 0.9rem;
    }
    .roles-header { 
      font-weight: bold; 
      margin-top: 1rem; 
      margin-bottom: 0.5rem; 
      color: #f1f5f9;
    }
    .no-assignments { 
      color: #94a3b8; 
      font-style: italic; 
      text-align: center; 
      padding: 1rem;
    }
    
    /* Player list styling */
    #playerList {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }
    #playerList li {
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #374151;
      border-radius: 6px;
      color: #f1f5f9;
    }
    
    /* Join link styling */
    code {
      background: #374151;
      color: #fbbf24;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
    
    /* Panel headers */
    h3 {
      margin-top: 0;
      color: #f1f5f9;
      font-size: 1.2rem;
    }
    
    /* Password management styles */
    .password-section {
      background: #1e293b;
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border: 1px solid #334155;
    }
    .password-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .password-input input[type="password"] {
      flex: 2;
      padding: 0.5rem;
      border: 1px solid #475569;
      border-radius: 6px;
      background: #374151;
      color: #f1f5f9;
    }
    .password-input input[type="password"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .password-status {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mafia Host Dashboard <span class="badge" id="gameStatus">Setup</span></h1>
    <div class="sub">Set up roles and wait for players to join.</div>
    
    <!-- Password Management Section -->
    <div class="password-section">
      <h3>Game Password</h3>
      <div class="password-input">
        <input type="password" id="gamePassword" placeholder="Enter password or leave empty..." />
        <button class="btn btn-primary" onclick="setPassword()">Set Password</button>
      </div>
      <div class="password-status" id="passwordStatus">No password set - anyone can join</div>
    </div>

    <div id="statusPanel" class="status waiting">
      <div id="statusText">Waiting for role setup...</div>
    </div>

    <div class="panel">
      <h3>Role Setup</h3>
      <div id="rolesContainer"></div>
      <button class="btn" onclick="addRole()" id="addRoleBtn">Add Role</button>
      <div class="total-count">Total Roles: <span id="totalRoles">0</span></div>
    </div>

    <div class="panel">
      <div>Players Joined <span class="count" id="playerCount">0</span></div>
      <ul id="playerList"></ul>
      
      <!-- New section for showing player roles -->
      <div id="playerRolesSection" style="display: none;">
        <div class="roles-header">ðŸŽ­ Player Role Assignments:</div>
        <div id="playerRolesList" class="player-roles"></div>
      </div>
      
      <div class="small time" id="time">Last updated: â€”</div>
    </div>

    <div class="panel">
      <button class="btn btn-success" onclick="assignRoles()" id="assignBtn" disabled>Assign Roles</button>
      <button class="btn btn-danger" onclick="resetGame()" id="resetBtn">Reset Game</button>
    </div>

    <p class="small">Share the join link: <code id="joinLink"></code></p>
  </div>

  <div class="footer">
    Created by Scissors
  </div>

  <script>
    const playerListEl = document.getElementById('playerList');
    const playerCountEl = document.getElementById('playerCount');
    const timeEl = document.getElementById('time');
    const joinLinkEl = document.getElementById('joinLink');
    const rolesContainer = document.getElementById('rolesContainer');
    const totalRolesEl = document.getElementById('totalRoles');
    const assignBtn = document.getElementById('assignBtn');
    const addRoleBtn = document.getElementById('addRoleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusPanel = document.getElementById('statusPanel');
    const statusText = document.getElementById('statusText');
    const gameStatus = document.getElementById('gameStatus');
    const playerRolesSection = document.getElementById('playerRolesSection');
    const playerRolesList = document.getElementById('playerRolesList');
    const gamePasswordEl = document.getElementById('gamePassword');
    const passwordStatusEl = document.getElementById('passwordStatus');

    joinLinkEl.textContent = `${location.protocol}//${location.host}/`;

    let roles = [];
    let gameStarted = false;

    function escapeHtml(str) {
      const p = document.createElement('p');
      p.innerText = str;
      return p.innerHTML;
    }

    function setPassword() {
      const password = gamePasswordEl.value;
      
      fetch('/api/set-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `password=${encodeURIComponent(password)}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (data.password_set) {
            passwordStatusEl.textContent = 'Password set successfully';
            passwordStatusEl.style.color = '#34d399';
          } else {
            passwordStatusEl.textContent = 'Password removed - anyone can join';
            passwordStatusEl.style.color = '#94a3b8';
          }
        }
      })
      .catch(error => {
        console.error('Error setting password:', error);
        passwordStatusEl.textContent = 'Error setting password';
        passwordStatusEl.style.color = '#f87171';
      });
    }

    function addRole() {
      const roleDiv = document.createElement('div');
      roleDiv.className = 'role-input';
      roleDiv.innerHTML = `
        <input type="text" placeholder="Role name (e.g., Mafia, Villager)" class="role-name">
        <input type="number" min="1" value="1" class="role-count">
        <button class="btn remove-btn" onclick="removeRole(this)">Remove</button>
      `;
      rolesContainer.appendChild(roleDiv);
      updateTotalRoles();
    }

    function removeRole(btn) {
      btn.parentElement.remove();
      updateTotalRoles();
    }

    function updateTotalRoles() {
      const roleCounts = document.querySelectorAll('.role-count');
      let total = 0;
      roleCounts.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      totalRolesEl.textContent = total;
      return total;
    }

    function collectRoles() {
      const roleInputs = document.querySelectorAll('.role-input');
      const collectedRoles = [];
      
      roleInputs.forEach(roleDiv => {
        const nameInput = roleDiv.querySelector('.role-name');
        const countInput = roleDiv.querySelector('.role-count');
        const name = nameInput.value.trim();
        const count = parseInt(countInput.value) || 0;
        
        if (name && count > 0) {
          collectedRoles.push({ name, count });
        }
      });
      
      return collectedRoles;
    }

    // New function to display player role assignments
    function displayPlayerRoles(assignments) {
      if (!assignments || Object.keys(assignments).length === 0) {
        playerRolesSection.style.display = 'none';
        return;
      }

      playerRolesSection.style.display = 'block';
      playerRolesList.innerHTML = '';

      // Sort players by name for consistent display
      const sortedPlayers = Object.keys(assignments).sort();
      
      sortedPlayers.forEach(playerName => {
        const roleDiv = document.createElement('div');
        roleDiv.className = 'player-role-item';
        roleDiv.innerHTML = `
          <span class="player-name">${escapeHtml(playerName)}</span>
          <span class="player-role">${escapeHtml(assignments[playerName])}</span>
        `;
        playerRolesList.appendChild(roleDiv);
      });
    }

    async function syncRoles() {
      const currentRoles = collectRoles();
      
      try {
        // Don't reset if game already started
        const statusResp = await fetch('/api/players');
        const statusData = await statusResp.json();
        if (statusData.game_started) {
          return;
        }
        
        // Clear server roles only (not players!)
        await fetch('/api/reset-roles', { method: 'POST' });
        
        // Add each role
        for (const role of currentRoles) {
          const resp = await fetch('/api/roles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `role_name=${encodeURIComponent(role.name)}&role_count=${role.count}`
          });
          if (!resp.ok) {
            console.error('Failed to add role:', role);
          }
        }
      } catch (e) {
        console.error('Error syncing roles:', e);
        throw e;
      }
    }

    async function assignRoles() {
      // First sync roles to server
      await syncRoles();
      
      // Small delay to ensure sync completes
      await new Promise(resolve => setTimeout(resolve, 100));
      
      try {
        const resp = await fetch('/api/assign', { method: 'POST' });
        const data = await resp.json();
        
        if (data.success) {
          gameStarted = true;
          addRoleBtn.disabled = true;
          assignBtn.disabled = true;
          document.querySelectorAll('.role-name, .role-count, .remove-btn').forEach(el => el.disabled = true);
          gameStatus.textContent = 'Started';
          statusText.textContent = 'Game started! Roles have been assigned.';
          statusPanel.className = 'status ready';
          
          // Refresh to show the role assignments
          setTimeout(refresh, 500);
        } else {
          alert('Error: ' + data.error);
          console.error('Assignment error:', data);
        }
      } catch (e) {
        console.error('Error assigning roles:', e);
        alert('Error assigning roles: ' + e.message);
      }
    }

    async function resetGame() {
      if (confirm('Are you sure you want to reset the game? This will clear all players and roles.')) {
        try {
          await fetch('/api/reset', { method: 'POST' });
          location.reload();
        } catch (e) {
          alert('Error resetting game');
        }
      }
    }

    async function refresh() {
      try {
        const resp = await fetch('/api/players', { cache: 'no-store' });
        const data = await resp.json();
        
        playerCountEl.textContent = data.count;
        
        playerListEl.innerHTML = '';
        for (const playerName of data.players) {
          const li = document.createElement('li');
          li.innerHTML = escapeHtml(playerName);
          playerListEl.appendChild(li);
        }
        
        // Display role assignments if game has started
        if (data.game_started && data.assignments) {
          displayPlayerRoles(data.assignments);
        } else {
          playerRolesSection.style.display = 'none';
        }
        
        // Get frontend total roles
        const frontendTotalRoles = updateTotalRoles();
        
        // Check if we can start based on frontend roles (not server roles)
        const canStart = data.count > 0 && frontendTotalRoles > 0 && data.count === frontendTotalRoles && !data.game_started;
        assignBtn.disabled = !canStart;
        
        if (data.game_started) {
          gameStarted = true;
          addRoleBtn.disabled = true;
          assignBtn.disabled = true;
          document.querySelectorAll('.role-name, .role-count, .remove-btn').forEach(el => el.disabled = true);
          gameStatus.textContent = 'Started';
          statusText.textContent = 'Game started! Roles have been assigned.';
          statusPanel.className = 'status ready';
        } else if (canStart) {
          statusText.textContent = `Ready to start! ${data.count} players joined, ${frontendTotalRoles} roles configured.`;
          statusPanel.className = 'status ready';
        } else {
          statusText.textContent = `Waiting... ${data.count}/${frontendTotalRoles} players joined.`;
          statusPanel.className = 'status waiting';
        }
        
        // Update password status
        if (data.password_set) {
          passwordStatusEl.textContent = 'Password is set';
          passwordStatusEl.style.color = '#34d399';
        } else {
          passwordStatusEl.textContent = 'No password set - anyone can join';
          passwordStatusEl.style.color = '#94a3b8';
        }
        
        const now = new Date();
        timeEl.textContent = 'Last updated: ' + now.toLocaleTimeString();
      } catch (e) {
        timeEl.textContent = 'Last updated: (error contacting server)';
      }
    }

    // Add event listeners for role count changes
    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('role-count') || e.target.classList.contains('role-name')) {
        updateTotalRoles();
        // Trigger a refresh to update button state
        setTimeout(refresh, 100);
      }
    });

    // Add initial role
    addRole();

    // Poll every second
    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>