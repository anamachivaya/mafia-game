<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Your Role - Mafia Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/static/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mafia Game">
  <link rel="apple-touch-icon" href="/static/mafia_bg_pic.jpg">
  <link rel="stylesheet" href="/static/snazzy.css">
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      padding: 2rem; 
      background: #0f172a; 
      color: #e2e8f0; 
      min-height: 100vh;
      margin: 0;
    }
    .card { 
      max-width: 520px; 
      margin: 5vh auto; 
      background: #1e293b; 
      padding: 2rem; 
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
      border: 1px solid #334155;
      position: relative;
    }
    .card.eliminated {
      border-color: #dc2626;
      background: #1a1a1a;
    }
    .status-indicator {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .status-alive {
      background: #059669;
      color: white;
    }
    .status-eliminated {
      background: #dc2626;
      color: white;
    }
    h1 { 
      margin-top: 0; 
      font-size: 1.6rem; 
      color: #f1f5f9;
      padding-right: 6rem;
    }
    h1.eliminated {
      color: #fca5a5;
      text-decoration: line-through;
    }
    .role-badge { 
      background: #fbbf24; 
      color: #92400e; 
      padding: 0.75rem 1.5rem; 
      border-radius: 8px; 
      font-weight: bold; 
      font-size: 1.2rem; 
      margin: 1rem 0; 
      text-align: center;
    }
    .role-badge.eliminated {
      background: #dc2626;
      color: white;
    }
    .warning { 
      background: #451a03; 
      color: #fbbf24; 
      padding: 1rem; 
      border-radius: 8px; 
      margin: 1rem 0; 
      border: 1px solid #92400e;
    }
    .description { 
      background: #374151; 
      padding: 1rem; 
      border-radius: 8px; 
      margin: 1rem 0; 
      color: #f1f5f9;
    }
    .description.eliminated {
      background: #4c1d1d;
      color: #fca5a5;
    }
    .button-group { 
      margin-top: 1.5rem; 
    }
    .btn { 
      padding: 0.8rem 1.5rem; 
      font-size: 1rem; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      margin-right: 0.5rem; 
      margin-bottom: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-primary { 
      background: #2563eb; 
      color: white; 
    }
    .btn-primary:hover { 
      background: #1e40af; 
    }
    .btn-danger { 
      background: #dc2626; 
      color: white; 
    }
    .btn-danger:hover { 
      background: #b91c1c; 
    }
    .last-updated {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 1rem;
      text-align: center;
    }
    .footer { 
      text-align: center; 
      margin-top: 2rem; 
      color: #94a3b8; 
      font-size: 0.9rem; 
    }
    
    /* Elimination overlay */
    .elimination-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .elimination-message {
      background: #1e293b;
      padding: 3rem;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #dc2626;
      max-width: 400px;
    }
    .elimination-title {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .elimination-text {
      font-size: 1.5rem;
      color: #fca5a5;
      margin-bottom: 1rem;
    }
    .elimination-status {
      background: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: bold;
      display: inline-block;
    }
    
    /* Eliminated styling */
    .eliminated {
      opacity: 0.7;
    }
    /* Faction badge styles */
    .faction-badge {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: white;
      margin-left: 0.6rem;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .faction-mafia { background: #b91c1c; }
    .faction-villagers { background: #059669; }
    .faction-neutral { background: #6b7280; }
    .faction-unknown { background: #374151; color: #f1f5f9; }
    /* Unified faction color on player screen */
    .faction-unified { background: #2563eb; }
  </style>
</head>
<body>
  <div class="card" id="gameCard">
    <div class="status-indicator status-alive" id="statusIndicator">ALIVE</div>
    
    <h1 id="playerName">Welcome, {{ name | e }}!</h1>
    
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <div class="role-badge" id="roleBadge">{{ role | e }}</div>
      {% if faction %}
        {# Show a unified faction badge color on the player role screen for consistency #}
        <span class="faction-badge faction-unified">{{ faction | e }}</span>
      {% endif %}
    </div>
    
    <div class="warning" id="warningMessage">
      ü§´ Keep your role secret! Don't let other players see this screen.
    </div>
    
    <div class="description" id="roleDescription">
      {{ description | e }}
    </div>

    <!-- Visible teammates (e.g., mafias see other mafias) -->
    <div id="visibleTeammatesSection" style="display:none; margin-top:1rem;">
      <div class="roles-header">üïµÔ∏è‚Äç‚ôÇÔ∏è Teammates you can see</div>
      <div id="visibleTeammatesList" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
    </div>
    
    <div class="button-group">
  <!-- Removed manual refresh: players view role automatically via the main page -->
      
      <form method="post" action="{{ url_for('leave') }}" style="display: inline;">
        <input type="hidden" name="player_name" value="{{ name }}">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to leave the game?')">Leave Game</button>
      </form>
    </div>
    
    <div class="last-updated" id="lastUpdated">Last checked: ‚Äî</div>
  </div>

  <!-- Elimination overlay -->
  <div class="elimination-overlay" id="eliminationOverlay">
    <div class="elimination-message">
      <div class="elimination-title">üíÄ</div>
      <div class="elimination-text">You have been eliminated!</div>
      <div class="elimination-status">ELIMINATED</div>
      <p style="color: #94a3b8; margin-top: 2rem;">
        You can continue to watch the game, but you can no longer participate.
      </p>
      <button class="btn btn-primary" onclick="window.location.href='/watch/' + encodeURIComponent(ROOM_NAME)" style="margin-top: 1rem;">
        Continue Watching
      </button>
    </div>
  </div>

  <!-- Toast notification for brief messages before redirects -->
  <div id="toast" style="display:none; position: fixed; left: 50%; transform: translateX(-50%); bottom: 12vh; background: rgba(0,0,0,0.7); color: #fff; padding: 0.8rem 1.2rem; border-radius: 8px; font-weight: 700; box-shadow: 0 6px 20px rgba(0,0,0,0.5); z-index: 1100;">
    <span id="toastMessage">Message</span>
  </div>

  <div class="footer">
    Created by Scissors. Powered by Sunisha and Diet Coke
  </div>

  <script>
    const PLAYER_NAME = '{{ name | e }}';
    const ROOM_NAME = '{{ room_name | e }}';
    
    let isEliminated = false;
    let hasShownEliminationMessage = false;

    function escapeHtml(str) {
      const p = document.createElement('p');
      p.innerText = str;
      return p.innerHTML;
    }

    function showToast(msg, ms = 1200) {
      try {
        const toast = document.getElementById('toast');
        const msgEl = document.getElementById('toastMessage');
        msgEl.textContent = msg;
        toast.style.display = 'block';
        // fade in
        toast.style.opacity = 0;
        toast.style.transition = 'opacity 160ms ease';
        requestAnimationFrame(() => { toast.style.opacity = 1; });
        setTimeout(() => {
          // fade out
          toast.style.opacity = 0;
          setTimeout(() => { toast.style.display = 'none'; }, 220);
        }, ms);
      } catch (e) { console.warn('Toast failed', e); }
    }

    function showEliminationOverlay() {
      if (!hasShownEliminationMessage) {
        document.getElementById('eliminationOverlay').style.display = 'flex';
        hasShownEliminationMessage = true;
      }
    }

    function hideEliminationOverlay() {
      document.getElementById('eliminationOverlay').style.display = 'none';
    }

    function updateEliminationStatus(eliminated) {
      const gameCard = document.getElementById('gameCard');
      const playerName = document.getElementById('playerName');
      const roleBadge = document.getElementById('roleBadge');
      const roleDescription = document.getElementById('roleDescription');
      const statusIndicator = document.getElementById('statusIndicator');
      const warningMessage = document.getElementById('warningMessage');

      if (eliminated && !isEliminated) {
        // Player just got eliminated
        isEliminated = true;
        
        // Update visual elements
        gameCard.classList.add('eliminated');
        playerName.classList.add('eliminated');
        roleBadge.classList.add('eliminated');
        roleDescription.classList.add('eliminated');
        
        statusIndicator.textContent = 'ELIMINATED üíÄ';
        statusIndicator.className = 'status-indicator status-eliminated';
        
        warningMessage.innerHTML = 'üíÄ You have been eliminated from the game!';
        warningMessage.style.background = '#4c1d1d';
        warningMessage.style.color = '#f87171';
        warningMessage.style.borderColor = '#dc2626';
        
        // Show elimination overlay
        showEliminationOverlay();
        
      } else if (!eliminated && isEliminated) {
        // Player was revived (unlikely but possible)
        isEliminated = false;
        
        // Remove elimination styling
        gameCard.classList.remove('eliminated');
        playerName.classList.remove('eliminated');
        roleBadge.classList.remove('eliminated');
        roleDescription.classList.remove('eliminated');
        
        statusIndicator.textContent = 'ALIVE';
        statusIndicator.className = 'status-indicator status-alive';
        
        warningMessage.innerHTML = "ü§´ Keep your role secret! Don't let other players see this screen.";
        warningMessage.style.background = '#451a03';
        warningMessage.style.color = '#fbbf24';
        warningMessage.style.borderColor = '#92400e';
        
        hideEliminationOverlay();
      }
    }

    async function checkEliminationStatus() {
      try {
        const response = await fetch(`/api/rooms/${encodeURIComponent(ROOM_NAME)}/players`, {
          cache: 'no-store'
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch player status');
        }
        
        const data = await response.json();
  const eliminatedPlayers = data.eliminated_players || [];
        const isPlayerEliminated = eliminatedPlayers.includes(PLAYER_NAME);
        
        updateEliminationStatus(isPlayerEliminated);

        // If the host has restarted the game, assignments may be cleared and game_started will be false.
        // In that case, redirect this player back to the waiting/thanks page so they see the lobby.
        const gameStarted = !!data.game_started;
        const assignments = data.assignments || {};
        const hasAssignment = Object.prototype.hasOwnProperty.call(assignments, PLAYER_NAME);
        if (!gameStarted || !hasAssignment) {
          // Show a brief toast so player understands what's happening, then redirect back to the lobby/waiting page
          showToast('Host restarted the game ‚Äî returning to lobby...', 1400);
          setTimeout(() => {
            window.location.replace(`/room/${encodeURIComponent(ROOM_NAME)}`);
          }, 1400);
          return;
        }
        
        // Update last checked time
        const now = new Date();
        document.getElementById('lastUpdated').textContent = 
          'Last checked: ' + now.toLocaleTimeString();

        // Render visible teammates if provided (e.g., mafia members)
        try {
          const visible = data.visible_roles || [];
          const section = document.getElementById('visibleTeammatesSection');
          const list = document.getElementById('visibleTeammatesList');
          if (visible && visible.length) {
            section.style.display = 'block';
            list.innerHTML = '';
            visible.forEach(v => {
              const el = document.createElement('div');
              el.style.display = 'flex';
              el.style.justifyContent = 'space-between';
              el.style.alignItems = 'center';
              el.style.padding = '0.5rem';
              el.style.background = '#111827';
              el.style.borderRadius = '8px';
              el.innerHTML = `<strong>${escapeHtml(v.name)}</strong><span class="faction-badge faction-unified">${escapeHtml(v.role)}</span>`;
              list.appendChild(el);
            });
          } else {
            section.style.display = 'none';
            list.innerHTML = '';
          }
        } catch (e) { console.warn('Could not render visible teammates', e); }
        
      } catch (error) {
        console.error('Error checking elimination status:', error);
        document.getElementById('lastUpdated').textContent = 
          'Last checked: Error connecting to server';
      }
    }

    // Check elimination status immediately and then every 3 seconds
    checkEliminationStatus();
    setInterval(checkEliminationStatus, 3000);
  </script>
</body>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/static/sw.js').catch(function(err){ console.warn('SW registration failed:', err); });
    });
  }
</script>
</html>