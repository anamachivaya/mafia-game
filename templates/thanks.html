{% extends 'base.html' %}

{% block title %}Waiting — Mafia{% endblock %}

{% block head %}
  <style>
    /* Scoped tweaks for the waiting/thanks page */
    .card{max-width:720px;margin:6vh auto}
    .status-cta{margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center}
    #checkButton[disabled]{opacity:0.7;cursor:not-allowed}
  </style>
{% endblock %}

{% block content %}
  <div class="card">
    <h1>Welcome, {{ name | e }}!</h1>
    <p class="text-muted">You're in the lobby for room <strong>{{ room_name | e }}</strong>. Please wait while the host prepares the game.</p>

    <div id="statusIndicator" class="status-indicator waiting">
      <div id="statusText"><span class="state">Status:</span> <span id="statusMessage">Checking game status…</span></div>
      <div id="lastUpdated" class="last-updated">Last updated: —</div>
    </div>

    <p id="instructionText">The host will assign roles when ready. This page will automatically redirect you to your role when it becomes available.</p>

    <div id="lobbyPlayersSection" style="margin-top:1rem; display:none;">
      <div style="font-weight:700; margin-bottom:0.5rem;">Players in lobby (<span id="playerCount">0</span>)</div>
      <ul id="lobbyList" class="lobby-list" aria-live="polite"></ul>
    </div>

    <div class="status-cta">
      <button id="checkButton" class="btn btn-ghost" type="button">Refresh status</button>
      <button id="viewRoleBtn" class="btn btn-primary" disabled type="button">View my role</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const PLAYER = {{ name | tojson }};
    const ROOM = {{ room_name | tojson }};
    const statusMessage = document.getElementById('statusMessage');
    const lastUpdated = document.getElementById('lastUpdated');
    const lobbyList = document.getElementById('lobbyList');
    const playerCountEl = document.getElementById('playerCount');
    const lobbyPlayersSection = document.getElementById('lobbyPlayersSection');
    const viewRoleBtn = document.getElementById('viewRoleBtn');
    const checkButton = document.getElementById('checkButton');

    let lastTs = null;

    function renderPlayers(players){
      playerCountEl.textContent = (players || []).length;
      lobbyList.innerHTML = '';
      (players || []).forEach(p=>{
        const li = document.createElement('li');
        li.textContent = p;
        lobbyList.appendChild(li);
      });
      lobbyPlayersSection.style.display = (players && players.length) ? 'block' : 'none';
    }

    async function fetchStatus(){
      try{
        const res = await fetch(`/api/rooms/${encodeURIComponent(ROOM)}/players`, {cache:'no-store'});
        if (!res.ok) throw new Error('Network');
        const data = await res.json();
        const now = new Date();
        lastUpdated.textContent = 'Last updated: ' + now.toLocaleTimeString();

        // Update players display
        renderPlayers(data.players || []);

        // Determine assignment: prefer authoritative assignments mapping returned by players endpoint
        const assignments = data.assignments || {};
        const gameStarted = !!data.game_started;

        if (gameStarted && assignments && Object.keys(assignments).length){
          // If the server has marked game_started and assignments are present, check whether this player has an assignment
          if (assignments[PLAYER]){
            statusMessage.textContent = 'Role assigned — redirecting you to your role...';
            viewRoleBtn.disabled = false;
            viewRoleBtn.classList.remove('btn-ghost');
            viewRoleBtn.classList.add('btn-primary');
            // small delay so user sees message, then navigate to root which will render role view
            setTimeout(()=>{ window.location.href = '/'; }, 700);
            return;
          } else {
            statusMessage.textContent = 'Game started, awaiting assignment for you.';
            viewRoleBtn.disabled = false; // allow manual check
          }
        } else {
          statusMessage.textContent = `Waiting for host to assign roles... (${data.count || 0} players)`;
          viewRoleBtn.disabled = true;
        }

      }catch(err){
        statusMessage.textContent = 'Unable to reach server — retrying…';
      }
    }

    // Button handlers
    checkButton.addEventListener('click', function(){ fetchStatus(); });
    viewRoleBtn.addEventListener('click', function(){ window.location.href = '/'; });

    // Poll for updates but keep interval modest to avoid extra server load
    fetchStatus();
    setInterval(fetchStatus, 2500);
  })();
</script>
{% endblock %}
